box: maven:3.5.4-jdk-8
no-response-timeout: 15
command-timeout: 60

build:
  steps:	
    - blackbelttechnology/version-from-git-tag@1.0.2	

    - blackbelttechnology/version-from-pom@1.0.3:
      pom: epsilon-runtime-parent/pom.xml
      
    - wercker/maven:
      goals: versions:set
      pom: ./epsilon-runtime-parent/pom.xml
      maven_opts: -DnewVersion=${VERSION_FROM_POM_BASE_VERSION}-${VERSION_FROM_GIT_TAG_CURRENT_BRANCH_VALID_NAME}_${VERSION_FROM_GIT_TAG_COMMIT_COUNT}
      cache_repo: true

    - wercker/maven:
      goals: clean install
      settings: .maven.xml
      profiles: release-github
      cache_repo: true

release:
  steps:
    - blackbelttechnology/version-from-git-tag@1.0.0

    - script:
        name: check consitency
        code: |-
             if [[ $GIT_DIRTY == true ]] ; then
                echo "Git is dirty, canot release"
                exit 1
             fi
             if [[ $MAKE_RELEASE != true ]] ; then
                echo "Only release version can be deployed"
                exit 1
             fi
             
    - wercker/maven:
      goals: clean install
      settings: .maven.xml
      cache_repo: true

    - blackbelttechnology/import-gpg-keys@1.0.4:
      secretkeys: $GPG_SECRET_KEYS 
      ownertrust: $GPG_OWNERTRUST

    - blackbelttechnology/version-from-git-tag@1.0.2

    - wercker/maven:
      goals: versions:set
      pom: ./epsilon-runtime-parent/pom.xml
      maven_opts: -DnewVersion=$APP_VERSION
      cache_repo: true

    - wercker/maven:
      goals: clean deploy
      profiles: release-central
      settings: .maven.xml
      cache_repo: true

    - script:
        name: print version
        code: |-
             echo "=================================================================================================================================="
             echo "  RELEASE VERSION: ${APP_VERSION}  OK"
             echo "=================================================================================================================================="
