box: maven:3.5.4-jdk-8
no-response-timeout: 15
command-timeout: 60

build:
  steps:	
    - blackbelttechnology/import-gpg-keys@1.0.2:
      secretkeys: $GPG_SECRET_KEYS 
      ownertrust: $GPG_OWNERTRUST

    - blackbelttechnology/version-from-git-tag@1.0.0

    - wercker/maven:
      goals: versions:set
      pom: ./epsilon-runtime-parent/pom.xml
      maven_opts: -DnewVersion=$APP_VERSION
      cache_repo: true

    - wercker/maven:
      goals: clean deploy
      profiles: release
      settings: .maven.xml
      cache_repo: true
    - script:
        name: print version
        code: |-
             echo "=================================================================================================================================="
             echo "  VERSION: ${APP_VERSION}  OK"
             echo "=================================================================================================================================="

release:
  steps:
    - blackbelttechnology/import-gpg-keys@1.0.2:
      secretkeys: $GPG_SECRET_KEYS 
      ownertrust: $GPG_OWNERTRUST

    - blackbelttechnology/version-from-git-tag@1.0.0

    - script:
        name: check consitency
        code: |-
             if [[ $GIT_DIRTY == true ]] ; then
                echo "Git is dirty, canot release"
                exit 1
             fi
             if [[ $MAKE_RELEASE != true ]] ; then
                echo "Only release version can be deployed"
                exit 1
             fi

    - wercker/maven:
      goals: clean install
      settings: .maven.xml
      cache_repo: true

    - script:
        name: print version
        code: |-
             echo "=================================================================================================================================="
             echo "  RELEASE VERSION: ${APP_VERSION}  OK"
             echo "=================================================================================================================================="
